{% extends "base.html" %}

{% block title %}Metrics Dashboard - {{ current_user.get_full_name() }}{% endblock %}

{% block page_title %}Metrics Dashboard{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 10px;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .event-item {
        border-left: 4px solid #dee2e6;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
        border-radius: 0 8px 8px 0;
    }
    
    .event-item.event-success { border-left-color: #28a745; }
    .event-item.event-warning { border-left-color: #ffc107; }
    .event-item.event-danger { border-left-color: #dc3545; }
    .event-item.event-info { border-left-color: #17a2b8; }
    
    .chart-container {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .filter-controls {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Filter Controls -->
    <div class="filter-controls">
        <div class="row align-items-center">
            <div class="col-md-3">
                <label for="timeRange">Time Range:</label>
                <select id="timeRange" class="form-control">
                    <option value="1h">Last Hour</option>
                    <option value="24h" selected>Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="metricType">Metric Type:</label>
                <select id="metricType" class="form-control">
                    <option value="all">All Metrics</option>
                    <option value="response_time">Response Time</option>
                    <option value="error_rate">Error Rate</option>
                    <option value="user_activity">User Activity</option>
                    <option value="system_health">System Health</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="eventSeverity">Event Severity:</label>
                <select id="eventSeverity" class="form-control">
                    <option value="all">All Severities</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary" onclick="refreshMetrics()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Overview -->
    <div class="row">
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value" id="avgResponseTime">--</div>
                <div class="metric-label">Avg Response Time</div>
                <small class="text-muted">milliseconds</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value" id="errorRate">--</div>
                <div class="metric-label">Error Rate</div>
                <small class="text-muted">percentage</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value" id="activeUsers">--</div>
                <div class="metric-label">Active Users</div>
                <small class="text-muted">current</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value" id="systemUptime">--</div>
                <div class="metric-label">System Uptime</div>
                <small class="text-muted">percentage</small>
            </div>
        </div>
    </div>

    <!-- Charts and Analytics -->
    <div class="row">
        <div class="col-lg-8">
            <div class="chart-container">
                <h5><i class="fas fa-chart-line"></i> Response Time Trends</h5>
                <div id="responseTimeChart" style="height: 300px;">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>Chart will be displayed here</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-container">
                <h5><i class="fas fa-chart-pie"></i> Error Distribution</h5>
                <div id="errorChart" style="height: 300px;">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>Chart will be displayed here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Events -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-exclamation-triangle"></i> Recent System Events</h5>
                </div>
                <div class="card-body">
                    <div id="eventsList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Loading events...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Metrics Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-table"></i> Detailed Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="metricsTable">
                            <thead>
                                <tr>
                                    <th>Metric Type</th>
                                    <th>Value</th>
                                    <th>Description</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> Loading metrics...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentMetrics = [];
let currentEvents = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadMetrics();
    loadEvents();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('timeRange').addEventListener('change', refreshMetrics);
    document.getElementById('metricType').addEventListener('change', refreshMetrics);
    document.getElementById('eventSeverity').addEventListener('change', refreshEvents);
}

function refreshMetrics() {
    loadMetrics();
    loadEvents();
}

async function loadMetrics() {
    try {
        const response = await fetch('{{ url_for("api.metrics") }}');
        const data = await response.json();
        
        if (data.success) {
            currentMetrics = data.data;
            updateMetricsDisplay();
            updateMetricsTable();
        } else {
            console.error('Failed to load metrics:', data.error);
        }
    } catch (error) {
        console.error('Error loading metrics:', error);
    }
}

async function loadEvents() {
    try {
        const response = await fetch('{{ url_for("api.events") }}');
        const data = await response.json();
        
        if (data.success) {
            currentEvents = data.data;
            updateEventsDisplay();
        } else {
            console.error('Failed to load events:', data.error);
        }
    } catch (error) {
        console.error('Error loading events:', error);
    }
}

function updateMetricsDisplay() {
    if (currentMetrics.length === 0) {
        document.getElementById('avgResponseTime').textContent = '--';
        document.getElementById('errorRate').textContent = '--';
        document.getElementById('activeUsers').textContent = '--';
        document.getElementById('systemUptime').textContent = '--';
        return;
    }

    // Calculate average response time
    const responseTimeMetrics = currentMetrics.filter(m => m.metric_type === 'response_time');
    if (responseTimeMetrics.length > 0) {
        const avgResponseTime = responseTimeMetrics.reduce((sum, m) => sum + m.value, 0) / responseTimeMetrics.length;
        document.getElementById('avgResponseTime').textContent = Math.round(avgResponseTime);
    }

    // Calculate error rate
    const errorMetrics = currentMetrics.filter(m => m.metric_type === 'error_rate');
    if (errorMetrics.length > 0) {
        const avgErrorRate = errorMetrics.reduce((sum, m) => sum + m.value, 0) / errorMetrics.length;
        document.getElementById('errorRate').textContent = avgErrorRate.toFixed(2);
    }

    // Get active users
    const userActivityMetrics = currentMetrics.filter(m => m.metric_type === 'user_activity');
    if (userActivityMetrics.length > 0) {
        const latestUserActivity = userActivityMetrics[0];
        document.getElementById('activeUsers').textContent = Math.round(latestUserActivity.value);
    }

    // Calculate system uptime (mock data for now)
    document.getElementById('systemUptime').textContent = '99.9';
}

function updateMetricsTable() {
    const tbody = document.getElementById('metricsTableBody');
    const metricType = document.getElementById('metricType').value;
    
    let filteredMetrics = currentMetrics;
    if (metricType !== 'all') {
        filteredMetrics = currentMetrics.filter(m => m.metric_type === metricType);
    }

    if (filteredMetrics.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No metrics found</td></tr>';
        return;
    }

    tbody.innerHTML = filteredMetrics.map(metric => `
        <tr>
            <td><span class="badge badge-primary">${metric.metric_type.replace('_', ' ')}</span></td>
            <td><strong>${metric.value}</strong></td>
            <td>${metric.description || 'No description'}</td>
            <td><small class="text-muted">${new Date(metric.timestamp).toLocaleString()}</small></td>
        </tr>
    `).join('');
}

function updateEventsDisplay() {
    const eventsContainer = document.getElementById('eventsList');
    const severity = document.getElementById('eventSeverity').value;
    
    let filteredEvents = currentEvents;
    if (severity !== 'all') {
        filteredEvents = currentEvents.filter(e => e.severity === severity);
    }

    if (filteredEvents.length === 0) {
        eventsContainer.innerHTML = '<div class="text-center text-muted py-4"><p>No events found</p></div>';
        return;
    }

    eventsContainer.innerHTML = filteredEvents.map(event => `
        <div class="event-item event-${event.severity}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${event.message}</h6>
                    <small class="text-muted">${event.event_type} • ${event.source}</small>
                </div>
                <span class="badge badge-${getSeverityColor(event.severity)}">${event.severity}</span>
            </div>
            <small class="text-muted">${new Date(event.timestamp).toLocaleString()}</small>
        </div>
    `).join('');
}

function getSeverityColor(severity) {
    const colors = {
        'low': 'success',
        'medium': 'warning',
        'high': 'danger',
        'critical': 'danger',
        'info': 'info'
    };
    return colors[severity] || 'secondary';
}
</script>
{% endblock %}
